name: Build CV (LaTeX) + Next.js + Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  cv:
    name: Build CV (LaTeX)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: martinchipoco-cv.tex
          working_directory: .
          latexmk_use_xelatex: true

      - name: Rename -> cv.pdf
        run: mv martinchipoco-cv.pdf cv.pdf

      - name: Upload cv.pdf artifact
        uses: actions/upload-artifact@v4
        with:
          name: cv-pdf
          path: cv.pdf

  site:
  name: Build & Export Next.js (static)
  runs-on: ubuntu-latest
  needs: cv
  env:
    NEXT_TELEMETRY_DISABLED: 1
    NEXT_PUBLIC_BASE_PATH: /${{ github.event.repository.name }}
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm

    - name: Debug tree (antes)
      run: |
        pwd
        ls -la
        ls -la apps || true
        ls -la apps/web || true

    - name: Install deps (apps/web)
      working-directory: apps/web
      run: npm ci || npm i

    - name: Build (apps/web)
      run: npm --prefix apps/web run build

    - name: Export (apps/web â†’ apps/web/out)
      run: npm --prefix apps/web run export

    - name: Move export to repo root (out/)
      run: |
        rm -rf out
        mv apps/web/out out
        ls -la out || true
        ls -la out/images || true

    - name: Download cv.pdf (into out/)
      uses: actions/download-artifact@v4
      with:
        name: cv-pdf
        path: out

    - name: Verify cv.pdf
      run: |
        test -f out/cv.pdf || (echo "cv.pdf missing" && exit 1)

    - name: Upload Pages artifact (out)
      uses: actions/upload-pages-artifact@v3
      with:
        path: out


  deploy:
    name: Deploy to GitHub Pages
    needs: site
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
